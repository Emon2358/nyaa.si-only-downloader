name: âš¡ Download and Upload MP4

on:
  workflow_dispatch:
    inputs:
      torrent_url:
        description: 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ .torrent ã® URL'
        required: true
        default: 'https://sukebei.nyaa.si/download/3957463.torrent'

jobs:
  download-and-upload:
    runs-on: ubuntu-latest

    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆã‚³ãƒŸãƒƒãƒˆæ¨©é™ã¯ä¸è¦ã«ãªã‚Šã¾ã—ãŸãŒæ®‹ã—ã¦ã„ã¾ã™ï¼‰
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true
          fetch-depth: 0

      # 2. å¿…è¦ãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq aria2 python3-pip

      # 3. Torrent ã‹ã‚‰ MP4 ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      - name: Download via aria2c
        run: |
          mkdir content
          aria2c \
            --dir=content \
            --seed-time=0 \
            --split=16 \
            --max-connection-per-server=16 \
            --max-concurrent-downloads=4 \
            --min-split-size=1M \
            --retry-wait=5 \
            --timeout=60 \
            --summary-interval=1 \
            "${{ github.event.inputs.torrent_url }}"

      # 4. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸ MP4 ã‚’ GigaFileä¾¿ ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€URL ã‚’è¡¨ç¤º
      - name: Upload MP4 to GigaFileä¾¿ and show URLs
        run: |
          pip3 install --upgrade gigafile
          echo "=== Uploaded URLs ==="
          for f in content/*.mp4; do
            echo "ğŸ“¤ Uploading $f â€¦"
            # GigaFile CLI ãŒè¿”ã™ URL ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
            url=$(gfile upload "$f")
            echo "â†’ $url"
          done
