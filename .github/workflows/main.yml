name: âš¡ Download, Compress MP4, and Push to Repo

on:
  workflow_dispatch:
    inputs:
      torrent_url:
        description: 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ .torrent ã® URL'
        required: true
        default: 'https://sukebei.nyaa.si/download/3957463.torrent'

jobs:
  download-compress-push:
    runs-on: ubuntu-latest

    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆã‚³ãƒŸãƒƒãƒˆæ¨©é™ä»˜ãï¼‰
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true   # GITHUB_TOKEN ã‚’ç¶­æŒ
          fetch-depth: 0              # full history

      # 2. å¿…è¦ãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq aria2 ffmpeg

      # 3. Torrent ã‹ã‚‰ MP4 ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      - name: Download via aria2c
        run: |
          mkdir content
          aria2c \
            --dir=content \
            --seed-time=0 \
            --split=16 \
            --max-connection-per-server=16 \
            --max-concurrent-downloads=4 \
            --min-split-size=1M \
            --retry-wait=5 \
            --timeout=60 \
            --summary-interval=1 \
            "${{ github.event.inputs.torrent_url }}"

      # 4. MP4 ã‚’æœ€å¤§åœ§ç¸®
      - name: Compress MP4 files
        run: |
          mkdir compressed
          find content -type f -iname '*.mp4' | while IFS= read -r file; do
            echo "ğŸ”§ Compressing: $file"
            filename=$(basename "$file")
            # H.264ã§CRF35ã€very slowãƒ—ãƒªã‚»ãƒƒãƒˆã€AAC 128kbps ã§åœ§ç¸®
            ffmpeg -y -i "$file" \
              -c:v libx264 -preset veryslow -crf 35 \
              -c:a aac -b:a 128k \
              "compressed/$filename"
          done

      # 5. åœ§ç¸®å¾Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥
      - name: Commit and push compressed files
        run: |
          cd $GITHUB_WORKSPACE
          # Gitãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # å¤‰æ›´ãƒã‚§ãƒƒã‚¯
          if git diff --quiet --exit-code compressed/; then
            echo "No changes in compressed/ â€“ skipping commit."
          else
            git add compressed/
            git commit -m "Add compressed MP4 files"
            git push
          fi
