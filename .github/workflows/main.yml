name: âš¡ Download and Upload MP4

on:
  workflow_dispatch:
    inputs:
      torrent_url:
        description: 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ .torrent ã® URL'
        required: true
        default: 'https://sukebei.nyaa.si/download/4250850.torrent'

jobs:
  download-and-upload:
    runs-on: ubuntu-latest

    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true
          fetch-depth: 0

      # 2. ãƒ„ãƒ¼ãƒ«é¡ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq aria2 python3-pip ffmpeg

      # 3. Torrent ã‹ã‚‰ MP4 ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      - name: Download via aria2c
        run: |
          mkdir content
          aria2c \
            --dir=content \
            --seed-time=0 \
            --split=16 \
            --max-connection-per-server=16 \
            --max-concurrent-downloads=4 \
            --min-split-size=1M \
            --retry-wait=5 \
            --timeout=60 \
            --summary-interval=1 \
            "${{ github.event.inputs.torrent_url }}"

      # 4. ãƒ‡ãƒãƒƒã‚°ï¼šã‚¹ãƒˆãƒªãƒ¼ãƒ æƒ…å ±ã‚’è¡¨ç¤º
      - name: Probe downloaded MP4 streams
        run: |
          for f in content/*.mp4; do
            echo "=== $f ==="
            echo "-- video streams --"
            ffprobe -v error -select_streams v:0 -show_streams -show_entries stream=codec_name,width,height -of default=noprint_wrappers=1 "$f" || echo "no video"
            echo "-- audio streams --"
            ffprobe -v error -select_streams a:0 -show_streams -show_entries stream=codec_name -of default=noprint_wrappers=1 "$f" || echo "no audio"
          done  # ã‚¹ãƒˆãƒªãƒ¼ãƒ æƒ…å ±è¡¨ç¤ºã« ffprobe ã‚’ä½¿ç”¨ :contentReference[oaicite:0]{index=0}

      # 5. æ˜ åƒã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒãªã‘ã‚Œã°å¤±æ•—ã•ã›ã‚‹
      - name: Fail if no video stream
        run: |
          for f in content/*.mp4; do
            if ! ffprobe -v error -select_streams v -show_streams "$f" | grep -q codec_type=video; then
              echo "ERROR: $f ã« video ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ" >&2
              exit 1
            fi
          done

      # 6. ç¢ºå®Ÿã«æ˜ åƒï¼‹éŸ³å£°ã‚’å«ã‚€ã‚ˆã†å†ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼†faststart
      - name: Transcode MP4 for video+audio + faststart
        run: |
          mkdir streamable
          for f in content/*.mp4; do
            echo "ğŸ”„ Transcoding and faststart: $f"
            fn=$(basename "$f")
            ffmpeg -y -i "$f" \
              -c:v libx264 -preset veryslow -crf 23 -pix_fmt yuv420p \
              -c:a aac -b:a 128k \
              -movflags +faststart \
              "streamable/$fn"
          done  # H.264 ã«å†ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼†moov atom ã‚’å…ˆé ­ã«ç§»å‹• :contentReference[oaicite:1]{index=1}

      # 7. æœ€é©åŒ–æ¸ˆã¿ MP4 ã‚’ GigaFileä¾¿ ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã— URL è¡¨ç¤º
      - name: Upload to GigaFileä¾¿ and show URLs
        run: |
          pip3 install --upgrade gigafile
          echo "=== Uploaded URLs ==="
          for f in streamable/*.mp4; do
            echo "ğŸ“¤ Uploading $f â€¦"
            abs=$(realpath "$f")
            url=$(gfile upload "$abs")
            echo "â†’ $url"
          done
