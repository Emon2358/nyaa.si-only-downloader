name: âš¡ Download, Transcode & Release MP4

on:
  workflow_dispatch:
    inputs:
      torrent_url:
        description: 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ .torrent ã® URL'
        required: true
        default: 'https://sukebei.nyaa.si/download/4250850.torrent'
      release_tag:
        description: 'ä½œæˆã™ã‚‹ãƒªãƒªãƒ¼ã‚¹ã®ã‚¿ã‚°å'
        required: true
        default: 'v1.0.0'
      release_name:
        description: 'ä½œæˆã™ã‚‹ãƒªãƒªãƒ¼ã‚¹ã®åå‰'
        required: false
        default: ''

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. ãƒ„ãƒ¼ãƒ«é¡ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq aria2 python3-pip ffmpeg

      # 3. .torrent â†’ content/*.mp4
      - name: Download via aria2c
        run: |
          mkdir -p content
          aria2c \
            --dir=content \
            --seed-time=0 \
            --split=16 \
            --max-connection-per-server=16 \
            --max-concurrent-downloads=4 \
            --min-split-size=1M \
            --retry-wait=5 \
            --timeout=60 \
            --summary-interval=1 \
            "${{ github.event.inputs.torrent_url }}"

      # 4. è¶…é«˜é€Ÿå†ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆultrafast + threads autoï¼‰
      - name: Ultra-Fast Transcode for streaming
        run: |
          shopt -s nullglob
          mkdir -p streamable
          for f in content/*.mp4; do
            echo "ğŸ”„ Fast-transcoding: $f"
            fn=${f##*/}
            ffmpeg -y -threads 0 -i "$f" \
                   -c:v libx264 -preset ultrafast -crf 35 \
                   -c:a aac -b:a 64k \
                   -movflags +faststart \
                   "streamable/$fn"
          done

      # 5. Debug: streamable ãƒ•ã‚©ãƒ«ãƒ€å†…ã‚’ç¢ºèª
      - name: List streamable files
        run: |
          echo "=== streamable files ==="
          ls -l streamable

      # 6. GitHub Release ã®ä½œæˆ & streamable/*.mp4 ã‚’ã™ã¹ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Create GitHub Release and upload artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: ${{ github.event.inputs.release_name || github.event.inputs.release_tag }}
          files: streamable/*.mp4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
