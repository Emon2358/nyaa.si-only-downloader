name: âš¡ Torrent å†…ã® MP4 ã®ã¿ GigaFileä¾¿ ã«é«˜é€Ÿã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰

on:
  workflow_dispatch:
    inputs:
      torrent_url:
        description: 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ .torrent ã® URL'
        required: true
        default: 'https://sukebei.nyaa.si/download/3957463.torrent'

jobs:
  upload-mp4-only:
    runs-on: ubuntu-latest

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq aria2 curl python3-pip

      - name: Download via aria2c (max parallel)
        run: |
          mkdir content
          aria2c \
            --dir=content \
            --seed-time=0 \
            --split=16 \
            --max-connection-per-server=16 \
            --max-concurrent-downloads=4 \
            --min-split-size=1M \
            --retry-wait=5 \
            --timeout=60 \
            --summary-interval=1 \
            "${{ github.event.inputs.torrent_url }}"

      - name: Install gfile CLI for GigaFileä¾¿
        run: |
          pip3 install --no-cache-dir git+https://github.com/Sraq-Zit/gfile.git

      - name: Upload each MP4 to GigaFileä¾¿ with retry logic
        id: upload
        run: |
          declare -a uploaded
          MAX_RETRIES=5
          SLEEP_INTERVAL=10

          # MP4 ãƒ•ã‚¡ã‚¤ãƒ«ã ã‘ã‚’åˆ—æŒ™
          find content -type f -iname '*.mp4' | while read -r file; do
            echo "ğŸ“¤ Uploading: $file"

            attempt=1
            success=false
            until [ "$attempt" -gt "$MAX_RETRIES" ] ; do
              # -n 4: 4ã‚¹ãƒ¬ãƒƒãƒ‰ä¸¦åˆ—ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰, -p: ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼éè¡¨ç¤º
              if url=$(gfile upload -n 4 -p "$file"); then
                echo "âœ… Success: $url"
                success=true
                break
              else
                echo "âš ï¸  Upload failed (attempt $attempt/$MAX_RETRIES), retrying in ${SLEEP_INTERVAL}s..."
                attempt=$((attempt+1))
                sleep $SLEEP_INTERVAL
              fi
            done

            if [ "$success" = false ] ; then
              echo "âŒ Failed to upload $file after $MAX_RETRIES attempts" >&2
              exit 1
            fi

            uploaded+=("$file: $url")
          done

          # çµæœã‚’ã¾ã¨ã‚ã¦å‡ºåŠ›å¤‰æ•°ã«
          echo "results<<EOF" >> $GITHUB_OUTPUT
          for entry in "${uploaded[@]}"; do
            echo "$entry"
          done >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Show uploaded MP4 URLs
        run: |
          echo "===== MP4 ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰çµæœ ====="
          echo "${{ steps.upload.outputs.results }}"
